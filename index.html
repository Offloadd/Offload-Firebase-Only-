                                    <button class="zone-toggle-btn" onclick="toggleZoneLabel('threat')">${state.zoneLabelsExpanded.threat ? '-' : '?'}</button>
                                </div>
                                <div class="zone-label-details">
                                    Fear, anxiety, activated feelings, anger, hopelessness, powerlessness, threat of pain responses
                                </div>
                            </div>
                            <div class="zone-label ${state.zoneLabelsExpanded.stable ? 'expanded' : ''}">
                                <div class="zone-label-title">
                                    <span>ðŸ”µ Regulated State</span>
                                    <button class="zone-toggle-btn" onclick="toggleZoneLabel('stable')">${state.zoneLabelsExpanded.stable ? '-' : '?'}</button>
                                </div>
                                <div class="zone-label-details">
                                    Grounded, calm, approachable, present
                                </div>
                            </div>
                            <div class="zone-label ${state.zoneLabelsExpanded.opportunity ? 'expanded' : ''}">
                                <div class="zone-label-title">
                                    <span>ðŸŸ¢ Opportunity Response</span>
                                    <button class="zone-toggle-btn" onclick="toggleZoneLabel('opportunity')">${state.zoneLabelsExpanded.opportunity ? '-' : '?'}</button>
                                </div>
                                <div class="zone-label-details">
                                    Enthusiasm, joy, sexual feelings, hunger, expansiveness, freedom feelings
                                </div>
                            </div>
                        </div>

                        <svg viewBox="0 0 600 300" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="waterGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#0088ff;stop-opacity:0.4" />
                                    <stop offset="100%" style="stop-color:#0088ff;stop-opacity:0.9" />
                                </linearGradient>
                            </defs>
                            <path id="riverChannel" class="river-channel" d=""/>
                            <path id="riverWater" class="river-water" d=""/>
                        </svg>

                        <div class="gate-top">
                            <div class="gate-shape-top" id="gateShapeTop">
                                <div class="gate-interior-top"></div>
                                <div class="gate-outline-top"></div>
                            </div>
                        </div>

                        <div class="gate-bottom">
                            <div class="gate-shape-bottom" id="gateShapeBottom">
                                <div class="gate-interior-bottom"></div>
                                <div class="gate-outline-bottom"></div>
                            </div>
                        </div>

                        <div class="gate-text-top" id="gateTextTop">THREAT<br>0</div>
                        <div class="gate-text-bottom" id="gateTextBottom">OPPORTUNITY<br>0</div>
                        <div class="river-text" id="riverText">Window of Tolerance Width<br>or Internal Information<br>Processing Capacity</div>
                        <div class="neutral-list" id="neutralList"></div>
                        
                        <div class="contributors-list contributors-threat" id="contributorsThreat"></div>
                        <div class="contributors-list contributors-opportunity" id="contributorsOpportunity"></div>

                        <div class="ground-label">Window of Tolerance<br>Threat: ${threatLoad} | Neutral: ${neutralCount} | Opportunity: ${opportunityLoad}</div>
                    </div>
                </div>

                <div class="card" style="border: 2px solid #9333ea;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${state.systemLoadVisible ? '12px' : '0'};">
                        <h2 style="margin: 0;">System Load Summary</h2>
                        <button class="btn btn-toggle" onclick="toggleSystemLoadVisibility()">
                            ${state.systemLoadVisible ? 'â–² Collapse' : 'â–¼ Expand'}
                        </button>
                    </div>
                    
                    ${state.systemLoadVisible ? `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 9px; margin: 12px 0;">
                        <div style="background: #fee2e2; padding: 9px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 3px;">Threat Load</div>
                            <div style="font-size: 28px; font-weight: bold; color: #dc2626;">${threatLoad}</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">Dysregulated</div>
                        </div>
                        <div style="background: #dbeafe; padding: 9px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 3px;">Neutral Areas</div>
                            <div style="font-size: 28px; font-weight: bold; color: #3b82f6;">${neutralCount}</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">Regulated</div>
                        </div>
                        <div style="background: #d1fae5; padding: 9px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 3px;">Opportunity Load</div>
                            <div style="font-size: 28px; font-weight: bold; color: #16a34a;">${opportunityLoad}</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">Enthusiasm/Fun</div>
                        </div>
                    </div>
                    <div class="status-box" style="background: ${status.color}; border-color: ${status.border}; color: ${status.textColor};">
                        <span class="status-icon">${status.icon}</span>
                        <span style="font-weight: 600;">${status.text}</span>
                    </div>
                    ` : ''}
                </div>

                <div class="card" style="border: 2px solid #16a34a;">
                    <h2>ðŸ’¾ Save Current Entry</h2>
                    <div class="subtitle" style="margin-bottom: 12px;">Save a timestamped snapshot of all current ratings to Google Sheets</div>
                    
                    ${state.saveError ? `<div class="error-message">${state.saveError}</div>` : ''}
                    
                    <button class="btn btn-success" onclick="saveEntry()">Save Entry</button>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h2 style="margin: 0;">Saved Entries: ${state.entries.length}</h2>
                        <button class="btn" style="background: #3b82f6; color: white;" onclick="copyEntries()" ${state.entries.length === 0 ? 'disabled style="background: #d1d5db; cursor: not-allowed;"' : ''}>ðŸ“‹ Copy All</button>
                    </div>
                    
                    ${state.entries.length === 0 ? '<div style="text-align: center; padding: 36px 0; color: #6b7280;">No saved entries yet</div>' : `
                        <div style="max-height: 450px; overflow-y: auto;">
                            ${state.entries.map(e => {
                                const config = e.lifeAreasConfig || state.lifeAreasConfig;
                                const types = e.ambientTypes || state.ambientTypes;
                                return `
                                <div class="entry-item">
                                    <div class="entry-timestamp">
                                        ${new Date(e.timestamp).toLocaleString()}
                                    </div>
                                    
                                    <div class="entry-section">
                                        <div class="entry-section-title">System Loads</div>
                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 6px;">
                                            <div style="background: #fee2e2; padding: 6px; border-radius: 4px; text-align: center;">
                                                <div style="font-size: 10px; color: #6b7280;">Threat</div>
                                                <div style="font-size: 18px; font-weight: bold; color: #dc2626;">${e.threatLoad || 0}</div>
                                            </div>
                                            <div style="background: #dbeafe; padding: 6px; border-radius: 4px; text-align: center;">
                                                <div style="font-size: 10px; color: #6b7280;">Neutral</div>
                                                <div style="font-size: 18px; font-weight: bold; color: #3b82f6;">${e.neutralCount || 0}</div>
                                            </div>
                                            <div style="background: #d1fae5; padding: 6px; border-radius: 4px; text-align: center;">
                                                <div style="font-size: 10px; color: #6b7280;">Opportunity</div>
                                                <div style="font-size: 18px; font-weight: bold; color: #16a34a;">${e.opportunityLoad || 0}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="entry-section">
                                        <div class="entry-section-title">Life Areas (Total: ${e.lifeTotal})</div>
                                        <div class="entry-life-areas">
                                            ${config.map(c => {
                                                const value = -(e.lifeAreas[c.key] || 0);
                                                return `<div>${c.label}: <strong>${value}</strong></div>`;
                                            }).join('')}
                                        </div>
                                    </div>

                                    <div class="entry-section">
                                        <div class="entry-section-title">Internal Experiences</div>
                                        ${e.ambient.filter(a => a.value !== 0).length === 0 ? 
                                            '<div style="font-style: italic; color: #6b7280; font-size: 12px;">No internal experiences recorded</div>' :
                                            e.ambient.filter(a => a.value !== 0).map((a, i) => {
                                                return `
                                                <div class="entry-ambient">
                                                    <div class="entry-ambient-header">[${a.value}/15] - ${getTypeLabel(a.type, types)}</div>
                                                    <div class="entry-ambient-note">"${a.note}"</div>
                                                </div>
                                            `;
                                            }).join('')
                                        }
                                    </div>

                                    <div class="entry-total">
                                        Total Load: ${e.total} (${e.pct}%)
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;

            document.getElementById('app').innerHTML = html;
            
            setTimeout(() => updateVisualization(threatLoad, opportunityLoad, neutralCount), 0);
        }

        // Initialize and render
        initializeState();
        render();
    </script>
</body>
</html>
